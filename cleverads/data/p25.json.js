window.repositoryObject = {"parameters":[],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p25","name":"SP_populate_world_cup","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"SP_populate_world_cup"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\nDECLARE finished INT DEFAULT 0;\r\nDECLARE v_sef_user VARCHAR(10);\r\nDECLARE v_domain_name VARCHAR(250);\r\nDECLARE v_reverse_domain VARCHAR(250);\r\nDECLARE v_min_neria INT;\r\nDECLARE v_max_neria INT;\r\nDECLARE v_count INT default 0;\r\n\r\n\r\n\r\nDECLARE c_world_cup_domains  \r\n\tCURSOR FOR\r\n\tSELECT sef_user,domain_name,reverse_domain,min_neria,max_neria\r\n\tFROM  `clevernt-cleverads-production`.`v_world_cup_domains` `a`;\r\n\t\r\n\t\r\n\r\nDECLARE CONTINUE HANDLER \r\n     FOR NOT FOUND SET finished = 1;\r\n\r\nTRUNCATE TABLE v_world_cup_hits;\r\nOPEN c_world_cup_domains;\r\nA:\r\nloop \r\n\tfetch c_world_cup_domains INTO v_sef_user,v_domain_name,v_reverse_domain,v_min_neria,v_max_neria;\r\n\tif finished = 1 then\r\n\t   close c_world_cup_domains;\r\n\t   leave A;\r\n\tEND if;\r\n\t\r\n\t\r\n\t\r\n\tINSERT INTO v_world_cup_hits (sef_user,domain_name,Country,brand,`Date`,`Week`,Tracker,hits)\r\n\t  \tSELECT \r\n\t  \tv_sef_user, \r\n\t  \tv_domain_name, \r\n\t  \t`nd`.`Country` AS `Country`, \r\n\t  \t`tb`.`Room` AS `brand`, \r\n\t  \tnd.Date,\r\n\t\t(\r\n\t    case when (\r\n\t      `nd`.`Date` <= '2022-09-25 23:59:59'\r\n\t    ) then 'Week-1' when (\r\n\t      `nd`.`Date` <= '2022-10-02 23:59:59'\r\n\t    ) then 'Week-2' when (\r\n\t      `nd`.`Date` <= '2022-10-09 23:59:59'\r\n\t    ) then 'Week-3' when (\r\n\t      `nd`.`Date` <= '2022-10-16 23:59:59'\r\n\t    ) then 'Week-4' when (\r\n\t      `nd`.`Date` <= '2022-10-23 23:59:59'\r\n\t    ) then 'Week-5' when (\r\n\t      `nd`.`Date` <= '2022-10-30 23:59:59'\r\n\t    ) then 'Week-6' when (\r\n\t      `nd`.`Date` <= '2022-11-06 23:59:59'\r\n\t    ) then 'Week-7' when (\r\n\t      `nd`.`Date` <= '2022-11-13 23:59:59'\r\n\t    ) then 'Week-8' when (\r\n\t      `nd`.`Date` <= '2022-11-20 23:59:59'\r\n\t    ) then 'Week-9' else 'Error' end\r\n\t  ) AS `Week`, \r\n\t  SUBSTRING_INDEX(\r\n\t\tREPLACE(\r\n\t\tREPLACE(`nt`.`InfoTracker`,'_',' '),'-',' '),' ',((\r\n\t\tREPLACE(\r\n\t\tREPLACE(`nt`.`InfoTracker`,'_',' '),'-',' ') REGEXP '[A-Z]{15}') * -(1))) AS `Tracker`, \r\n\t  sum(`nd`.`Hits`) AS `hits` \r\n\tFROM  `clevernt-cleverads-production`.`neria_download_stats_detail` `nd`  FORCE  index(ReverseDomain) \r\n\tjoin `clevernt-stats-production`.`neria_tracker` `nt` on(`nt`.`IdTracker` = `nd`.`TrackerID`)\r\n\tjoin `clevernt-stats-production`.`tbRoom` `tb` on(`tb`.`ID` = `nt`.`RoomID`)\r\n\twhere `nd`.`GroupID` BETWEEN v_min_neria and v_max_neria\r\n\tAND   `nd`.`Hits` > 0 \r\n\tAND   `nd`.`Date` >= '2022-09-19 00:00:00'\r\n\tAND   `nd`.`ReverseDomain` = v_reverse_domain\r\n\r\n\tGROUP BY    `nd`.`Country`, \r\n\t\t\t\t  \t`tb`.`Room`, \r\n\t\t\t\t  \tnd.Date,\r\n\t\t\t\t    case when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-09-25 23:59:59'\r\n\t\t\t\t    ) then 'Week-1' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-10-02 23:59:59'\r\n\t\t\t\t    ) then 'Week-2' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-10-09 23:59:59'\r\n\t\t\t\t    ) then 'Week-3' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-10-16 23:59:59'\r\n\t\t\t\t    ) then 'Week-4' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-10-23 23:59:59'\r\n\t\t\t\t    ) then 'Week-5' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-10-30 23:59:59'\r\n\t\t\t\t    ) then 'Week-6' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-11-06 23:59:59'\r\n\t\t\t\t    ) then 'Week-7' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-11-13 23:59:59'\r\n\t\t\t\t    ) then 'Week-8' when (\r\n\t\t\t\t      `nd`.`Date` <= '2022-11-20 23:59:59'\r\n\t\t\t\t    ) then 'Week-9' else 'Error' end, \r\n\t\t\t\t  SUBSTRING_INDEX(\r\n\t\t\t\t\tREPLACE(\r\n\t\t\t\t\tREPLACE(`nt`.`InfoTracker`,'_',' '),'-',' '),' ',((\r\n\t\t\t\t\tREPLACE(\r\n\t\t\t\t\tREPLACE(`nt`.`InfoTracker`,'_',' '),'-',' ') REGEXP '[A-Z]{15}') * -(1)));\r\nEND loop;\r\nEND","imported_at":"2024-06-28 17:00"};