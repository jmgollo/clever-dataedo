window.repositoryObject = {"parameters":[{"name":"p_User_ID","description":null,"mode":"IN","data_type":"int(10, 0)","custom_fields":{},"linked_terms":[]},{"name":"p_Name_Domain","description":null,"mode":"IN","data_type":"varchar(50)","custom_fields":{},"linked_terms":[]}],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p29","name":"v_deal_lead_unification","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v_deal_lead_unification"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\n\r\nDECLARE v_name CHAR;\r\nDECLARE v_domain_id INTEGER;\r\nDECLARE v_owner_user_id INTEGER;\r\nDECLARE v_lead_id_dest INTEGER;\r\nDECLARE v_lead_id_origem INTEGER;\r\nDECLARE v_lead_domain_id_dest INTEGER;\r\nDECLARE v_lead_domain_id_origem  INTEGER;\r\n\r\nDECLARE finished INTEGER;\r\n\r\n\t\r\n\tDECLARE c_dest \r\n\t\tCURSOR FOR \r\n\t\t\tSELECT l.owner_user_id,\td.id ,MAX(d.lead_blocked_id) \r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON l.id = ld.lead_id\r\n\t\t\tINNER join domains d ON d.id = ld.domain_id\r\n\t\t\tWHERE d.lead_blocked_id IS NOT NULL\r\n\t\t\tAND l.status_id IN (8,14)\r\n\t\t\tAND (l.owner_user_id = p_User_ID OR p_User_ID = 0)\r\n\t\t\tAND (d.name = p_Name_Domain OR p_Name_Domain='')\r\n\t\t\tAND ld.deleted_at    = '0000-00-00 00:00:00'\r\n\t\t\tAND l.deleted_at     = '0000-00-00 00:00:00'\r\n\t\t\tGROUP BY l.owner_user_id,d.id\r\n\t\t\tHAVING COUNT(*) > 1;\r\n\t\t\t\r\n\t\t\t\t\t\r\n\tDECLARE c_ld_dest\r\n\t\tCURSOR FOR\r\n\t\t\tSELECT ld.id\r\n\t\t\tFROM   leads_domains ld \r\n\t\t\tWHERE  ld.lead_id     = v_lead_id_dest\r\n\t\t\tAND  \t ld.domain_id   = v_domain_id\r\n\t\t\tAND \t ld.deleted_at  = '0000-00-00 00:00:00';\r\n\t\t\t\r\n\tDECLARE c_lead_domain_origem \r\n\t\tCURSOR FOR \r\n\t\t\tSELECT l.id,ld.id\r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON l.id = ld.lead_id\r\n\t\t\tWHERE l.status_id   IN (8,14)\r\n\t\t\tAND ld.domain_id    = v_domain_id\r\n\t\t\tAND l.owner_user_id = v_owner_user_id\r\n\t\t\tAND ld.deleted_at   = '0000-00-00 00:00:00'\r\n\t\t\tAND l.deleted_at    = '0000-00-00 00:00:00'\r\n\t\t\tAND l.id <> v_lead_id_dest;\r\n\r\n\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\nSTART TRANSACTION;\r\n\tOPEN c_dest ;\r\nB: LOOP\r\n\r\n\t   \r\n\t\tFETCH c_dest  INTO  v_owner_user_id,v_domain_id,v_lead_id_dest;\r\n\t\tIF finished = 1 THEN \r\n\t\t   close c_dest;\r\n\t\t\tLEAVE B;\r\n\t\tEND IF;\r\n\t\t\r\n\t\t\r\n\t\tOPEN  c_ld_dest;\r\n      FETCH c_ld_dest into v_lead_domain_id_dest;\r\n     \tIF finished = 1 THEN \r\n\t\t   close c_ld_dest;\r\n\t\t\tLEAVE B;\r\n\t\tEND IF;\r\n      close c_ld_dest;\r\n      \r\n      OPEN c_lead_domain_origem;\r\nDUP:\tLOOP\r\n\r\n\t\t\tFETCH c_lead_domain_origem INTO  v_lead_id_origem,v_lead_domain_id_origem;\r\n\t\t\tIF finished = 1 THEN \r\n\t\t\t   set finished = 0;\r\n\t\t\t   close c_lead_domain_origem;\r\n\t\t\t\tLEAVE DUP;\r\n\t\t\tEND IF;\r\n\t\t\t\r\n\t\t\t\r\n\t      UPDATE leads_domains_neria\r\n\t      SET   lead_domain_id = v_lead_domain_id_dest\r\n\t      WHERE lead_domain_id = v_lead_domain_id_origem;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tupdate  leads_domains \r\n\t\t\tSET deleted_user_id = 1,\r\n\t\t\t    deleted_at      = SYSDATE()\r\n\t\t\tWHERE id = v_lead_domain_id_origem;\r\n\t\t\t\r\n\t\tEND loop DUP;\r\n\tEND LOOP B;\r\n \tCOMMIT;\r\nEND","imported_at":"2024-06-28 17:00"};