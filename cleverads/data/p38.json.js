window.repositoryObject = {"parameters":[],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p38","name":"v1_LostLead_to_Contact_Correction","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v1_LostLead_to_Contact_Correction"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\nDECLARE v_status_at DATETIME;\r\nDECLARE v_id INTEGER;\r\nDECLARE v_step INTEGER DEFAULT  0;\r\nDECLARE finished INTEGER DEFAULT 0;\r\n\r\n\t\r\n\tDECLARE c_ld \r\n\t\tCURSOR FOR \r\n\t\tSELECT l.id \r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_statuses_logs lg ON lg.lead_id = l.id\r\n\t\t\tWHERE status_id = 12\r\n\t\t\tAND   lg.new_status_id = 2\r\n\t\t\tAND   lg.status_at = (select MAX(lgn.status_at)\r\n\t\t\t\t\t\t             FROM leads_statuses_logs lgn\r\n\t\t\t\t\t\t             WHERE lg.lead_id = lgn.lead_id\r\n\t\t\t\t\t\t\t\t   \t  )\r\n\t\t\tAND datediff(now(), status_at)   > 180;\r\n\t\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\nSET v_step = 0;\r\nOPEN c_ld;\r\nB: LOOP\r\n\tFETCH c_ld INTO  v_id;\r\n\t\tIF finished = 1 THEN \r\n\t\t\tLEAVE B;\r\n\t\tEND IF;\r\n\t\tSET v_step = v_step +1;\r\n\t\t\r\n\t\tUPDATE leads l\r\n\t\tSET l.status_id = 1,\r\n\t\t    l.updated_user_id = 1,\r\n\t\t    l.updated_at = SYSDATE()    \r\n\t\twhere id = v_id;\r\n\t\t\r\n\t\t\r\n\t\tINSERT INTO leads_statuses_logs (lead_id,old_status_id,new_status_id,user_status_id,status_at)\r\n\t\tVALUES (v_id,12,1,1,SYSDATE());\r\n\t\t\r\n\t\tUPDATE Execution_Control \r\n\t\tSET step = v_step,\r\n\t\t    information = v_id;\r\n\t\t    \r\n\tEND LOOP B;\r\nEND","imported_at":"2024-06-28 17:00"};