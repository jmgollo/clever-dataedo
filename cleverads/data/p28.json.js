window.repositoryObject = {"parameters":[{"name":"p_User_ID","description":null,"mode":"IN","data_type":"int(10, 0)","custom_fields":{},"linked_terms":[]},{"name":"p_Name_Domain","description":null,"mode":"IN","data_type":"char(50)","custom_fields":{},"linked_terms":[]}],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p28","name":"v_contact_lead_unification","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v_contact_lead_unification"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\n\r\nDECLARE v_name CHAR;\r\nDECLARE v_domain_id INTEGER;\r\nDECLARE v_owner_user_id INTEGER;\r\nDECLARE v_lead_id_dest INTEGER;\r\nDECLARE v_lead_id_origem INTEGER;\r\nDECLARE v_lead_domain_id_dest INTEGER;\r\nDECLARE v_lead_domain_id_origem  INTEGER;\r\nDECLARE v_lead_contact_id INTEGER;\r\n\r\n\r\nDECLARE finished INTEGER;\r\n\r\n\t\r\n\tDECLARE c_dest \r\n\t\tCURSOR FOR \r\n\t\t\tSELECT l.owner_user_id,\td.id,MAX(l.id) \r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON l.id = ld.lead_id\r\n\t\t\tINNER join domains d ON d.id = ld.domain_id\r\n\t\t\tWHERE l.status_id = 13\r\n\t\t\tAND (l.owner_user_id = p_User_ID OR p_User_ID = 0)\r\n\t\t\tAND (d.name = p_Name_Domain OR p_Name_Domain='')\r\n\t\t\tAND ld.deleted_at    = '0000-00-00 00:00:00'\r\n\t\t\tAND l.deleted_at     = '0000-00-00 00:00:00'\r\n\t\t\tGROUP BY l.owner_user_id,d.id\r\n\t\t\tHAVING COUNT(*) > 1;\r\n\t\t\t\r\n\t\t\t\t\t\r\n\tDECLARE c_ld_dest\r\n\t\tCURSOR FOR\r\n\t\t\tSELECT ld.id\r\n\t\t\tFROM   leads_domains ld \r\n\t\t\tWHERE  ld.lead_id     = v_lead_id_dest\r\n\t\t\tAND  \t ld.domain_id   = v_domain_id\r\n\t\t\tAND \t ld.deleted_at  = '0000-00-00 00:00:00';\r\n\t\t\t\r\n\tDECLARE c_lead_domain_origem \r\n\t\tCURSOR FOR \r\n\t\t\tSELECT l.id,ld.id\r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON l.id = ld.lead_id\r\n\t\t\tWHERE l.status_id   = 13\r\n\t\t\tAND ld.domain_id    = v_domain_id\r\n\t\t\tAND l.owner_user_id = v_owner_user_id\r\n\t\t\tAND ld.deleted_at   = '0000-00-00 00:00:00'\r\n\t\t\tAND l.deleted_at    = '0000-00-00 00:00:00'\r\n\t\t\tAND l.id <> v_lead_id_dest;\r\n\t\t\t\r\n\tDECLARE c_contacts\r\n\t\tCURSOR FOR\r\n\t\t\tSELECT lco.id \r\n\t\t\tFROM   leads_contacts lco \r\n\t\t\tWHERE  lco.lead_id     = v_lead_id_origem\r\n\t\t\tAND \t lco.deleted_at  = '0000-00-00 00:00:00'\r\n\t\t   AND    NOT EXISTS (SELECT 1\r\n\t\t\t                   FROM leads_contacts lcd \r\n\t\t\t\t\t\t\t\t\t WHERE  lcd.lead_id \t\t    = v_lead_id_dest\r\n\t\t\t\t\t\t\t\t\t AND    lcd.contact_type_id = lco.contact_type_id\r\n\t\t\t\t\t\t\t\t\t AND    lcd.contact_name    = lco.contact_name\r\n\t\t\t\t\t\t\t\t\t AND    lcd.information     = lco.information\r\n\t\t\t\t\t\t\t\t\t AND    lcd.deleted_at      = '0000-00-00 00:00:00');\r\n\t\t\t\r\n\r\n\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\nSTART TRANSACTION;\r\n\tOPEN c_dest ;\r\n\tDOM: \r\n\tLOOP\r\n\r\n\t   \r\n\t\tFETCH c_dest  INTO  v_owner_user_id,v_domain_id,v_lead_id_dest;\r\n\t\tIF finished = 1 THEN \r\n\t\t   set finished = 0;\r\n\t\t   close c_dest;\r\n\t\t\tLEAVE DOM;\r\n\t\tEND IF;\r\n\t\t\r\n\t\t\r\n\t\tOPEN  c_ld_dest;\r\n      FETCH c_ld_dest into v_lead_domain_id_dest;\r\n     \tIF finished = 1 THEN \r\n     \t\tset finished = 0;\r\n\t\t   close c_ld_dest;\r\n\t\t\tLEAVE DOM;\r\n\t\tEND IF;\r\n      close c_ld_dest;\r\n      \r\n      \r\n      OPEN c_lead_domain_origem;\r\n\t\tDUP:\t\r\n\t\tLOOP\r\n\t\t\tFETCH c_lead_domain_origem INTO  v_lead_id_origem,v_lead_domain_id_origem;\r\n\t\t\tIF finished = 1 THEN \r\n\t\t\t   set finished = 0;\r\n\t\t\t   close c_lead_domain_origem;\r\n\t\t\t\tLEAVE DUP;\r\n\t\t\tEND IF;\r\n\t\t\t\r\n\t\t\t\r\n\t      UPDATE leads_domains_neria\r\n\t      SET   lead_domain_id  = v_lead_domain_id_dest\r\n\t      WHERE lead_domain_id  = v_lead_domain_id_origem;     \r\n\t           \t\r\n\t\t\t\r\n\t\t\tupdate  leads_domains \r\n\t\t\tSET deleted_user_id = 1,\r\n\t\t\t    deleted_at      = SYSDATE()\r\n\t\t\tWHERE id = v_lead_domain_id_origem;\r\n\r\n\t\r\n\t      \r\n\t\t\tOPEN c_contacts;\r\n\t\t\tCON:\r\n\t\t\tLOOP \t\t\r\n\t\t\t\tFETCH c_contacts  INTO  v_lead_contact_id;\r\n\t\t\t\tIF finished = 1 THEN \r\n\t\t\t\t   set finished = 0;\r\n\t\t\t   \tclose c_contacts;\r\n\t\t\t\t\tLEAVE CON;\r\n\t\t\t\tEND IF;\r\n\t\t      \r\n\t\t      UPDATE leads_contacts \r\n\t\t      SET   lead_id  = v_lead_id_dest,\r\n\t\t            updated_at      = SYSDATE(),\r\n\t\t            updated_user_id = 1\r\n\t\t      WHERE id  = v_lead_contact_id;    \r\n\t\t\tEND LOOP CON; \r\n\t\tEND loop DUP;\r\n\tEND LOOP DOM;\r\n\tUPDATE leads l\r\n\tSET deleted_at = SYSDATE(),\r\n\t    deleted_user_id = 1\r\n\tWHERE l.status_id   = 13\r\n\tAND   NOT EXISTS (SELECT 1 FROM leads_domains ld \r\n\t\t\t\t\t\t\tWHERE ld.lead_id = l.id \r\n\t\t\t\t\t\t\tAND   ld.deleted_at = '0000-00-00 00:00:00');\r\n \tCOMMIT;\r\nEND","imported_at":"2024-06-28 17:00"};