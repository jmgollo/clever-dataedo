window.repositoryObject = {"parameters":[],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p35","name":"v1_fix_expiredUpdateFile_error","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v1_fix_expiredUpdateFile_error"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\nDECLARE v_lead_id INTEGER;\r\nDECLARE v_owner_id INTEGER;\r\nDECLARE v_domain_id \tINTEGER;\r\nDECLARE finished INTEGER DEFAULT 0;\r\n\r\n\t\r\n\tDECLARE c_ld \r\n\t\tCURSOR FOR \r\n\t\t\tSELECT l.id,l.owner_user_id\r\n\t\t\tFROM leads l\r\n\t\t\tWHERE l.expired_upload_at IS NOT NULL\r\n\t\t\tAND l.status_id = 1\r\n\t\t\tAND expired_upload_at > '2020-10-01 14:39:57'\r\n\t\t\tAND l.deleted_at = '0000-00-00 00:00:00'\r\n\t\t\t\r\n\t\t\tAND EXISTS (SELECT 1 \r\n\t\t\t\t\t\t\tFROM leads_files lf \r\n\t\t\t\t\t\t\tWHERE lf.lead_id = l.id\r\n\t\t\t\t\t\t\tAND lf.file_category_id = 1) ;\r\n\t\t\t\t\t\t\t\r\n\tDECLARE c_domains\r\n\t\tCURSOR FOR \r\n\t\t\tSELECT ld.domain_id\r\n\t\t\tFROM leads_domains ld \r\n\t\t\tINNER JOIN domains d ON d.id = ld.domain_id\r\n\t\t\tWHERE ld.lead_id = v_lead_id\r\n\t\t\tAND   ld.deleted_at = '0000-00-00 00:00:00';\r\n\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\n\r\nOPEN c_ld;\r\nB: LOOP\r\n\tFETCH c_ld INTO  v_lead_id,v_owner_id;\r\n\t\tIF finished = 1 THEN \r\n\t\t\tLEAVE B;\r\n\t\tEND IF;\r\n\t\t\r\n\t\t\r\n\t\tUPDATE leads l\r\n\t\tSET l.status_id = 2,\r\n\t\t    l.updated_user_id = 1,\r\n\t\t    l.updated_at = SYSDATE()\r\n\t\tWHERE l.id = v_lead_id;\r\n\t\t\r\n\t\t\r\n\t\tINSERT INTO leads_statuses_logs (lead_id,old_status_id,new_status_id,user_status_id,status_at)\r\n\t\t       VALUES (v_lead_id,1,2,1,SYSDATE());\r\n\r\n\t\t\r\n\t\tOPEN c_domains;\r\n\tD: LOOP\r\n\t\tFETCH c_domains INTO  v_domain_id;\r\n\t\t\tIF finished = 1 THEN \r\n\t\t\t\tLEAVE D;\r\n\t\t\tEND IF;\r\n\r\n\t\t\t\r\n\t\t\tUPDATE domains d\r\n\t\t\tSET    d.user_blocked_id = v_owner_id,\r\n\t\t\t       d.updated_user_id =  1,\r\n\t\t\t       d.updated_at = SYSDATE(),\r\n\t\t\t       d.blocked_at = SYSDATE(),\r\n\t\t\t       d.lead_blocked_id = v_lead_id,\r\n\t\t\t       d.is_free = 0\r\n\t\t\tWHERE  d.id = v_domain_id\r\n\t\t\tAND    d.is_free = 1;\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tINSERT INTO domains_statuses_logs (domain_id,old_status,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t  new_status,action,user_blocked_id,lead_blocked_id,\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t  created_user_id,blocked_at,created_at)\r\n\t\t\t\t\t\tVALUES(v_domain_id,1,0,\"Correction\",v_owner_id,v_lead_id,1,SYSDATE(),SYSDATE());\r\n\r\n\t\t\r\n\t\tEND loop D;\r\n\t\tclose c_domains;\r\n\t\tset finished = 0;\r\n\tEND LOOP B;\r\n   close c_ld;\r\n\t\r\nEND","imported_at":"2024-06-28 17:00"};