window.repositoryObject = {"parameters":[],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p31","name":"v_remove_duplicated_status_log","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v_remove_duplicated_status_log"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\n\r\nDECLARE v_lead_id INTEGER;\r\nDECLARE v_old_status INTEGER;\r\nDECLARE v_new_status INTEGER;\r\nDECLARE v_status_at VARCHAR(16);\r\nDECLARE v_user_id INTEGER;\r\nDECLARE v_min INTEGER;\r\n\r\nDECLARE finished INTEGER;\r\n\r\n\t\r\n\tDECLARE c_dup \r\n\t\tCURSOR FOR \r\n\t\t\r\n\t\tSELECT lg.lead_id,lg.old_status_id,lg.new_status_id,DATE_FORMAT(lg.status_at,\"%Y-%m-%d %H:%i\") status_at,lg.user_status_id,MIN(id) minimo\r\n\t\tFROM leads_statuses_logs lg\r\n\t\tWHERE DATE_FORMAT(lg.status_at,\"%Y-%m-%d %H:%i\") > '2020-07-01 10:09'\r\n\t\tAND lg.old_status_id = 12\r\n\t\tGROUP BY lg.lead_id,lg.old_status_id,lg.new_status_id,DATE_FORMAT(lg.status_at,\"%Y-%m-%d %H:%i\"),lg.user_status_id\r\n\t\tHAVING COUNT(*) > 1;\r\n\t\t\t\r\n\t\t\t\t\t\r\n\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\nset finished = 0;\r\nSTART TRANSACTION;\r\n\tOPEN c_dup ;\r\nB: LOOP\r\n      \r\n\t   \r\n\t\tFETCH c_dup  INTO  v_lead_id,v_old_status,v_new_status,v_status_at,v_user_id,v_min;\r\n\t\tIF finished = 1 THEN \r\n \t\t   close c_dup;\r\n\t\t\tLEAVE B;\r\n\t\tEND IF;\r\n\t\r\n \t\tDELETE from leads_statuses_logs \r\n\t\tWHERE lead_id = v_lead_id\r\n      AND   old_status_id = v_old_status\r\n      AND   new_status_id = v_new_status\r\n      AND   user_status_id = v_user_id\r\n      AND   DATE_FORMAT(status_at,\"%Y-%m-%d %H:%i\") = DATE_FORMAT(v_status_at,\"%Y-%m-%d %H:%i\")\r\n\t\tAND   id <> v_min;\r\n\t\t\t\t\r\n\tEND LOOP B;\r\n \tCOMMIT;\r\nEND","imported_at":"2024-06-28 17:00"};