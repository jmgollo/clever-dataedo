window.repositoryObject = {"parameters":[],"parameters_custom_fields":[],"dependencies":{"uses":[],"used_by":[]},"object_id":"p30","name":"v_delete_leads_domains_others","subtype":"PROCEDURE","is_user_defined":false,"description":null,"summary":[{"field":"Documentation","value":{"_type":"link","name":"Cleverads","id":"d6"}},{"field":"Name","value":"v_delete_leads_domains_others"},{"field":"Type","value":"Procedure"}],"script":"BEGIN\r\n\r\nDECLARE v_lead_domain_id INTEGER;\r\n\r\n\r\n\r\n\r\n\r\nDECLARE finished INTEGER;\r\n\r\n\t\r\n\tDECLARE c_leads_domains_others\r\n\t\tCURSOR FOR \r\n\t\t\tSELECT ld.id AS lead_domain_id\r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON ld.lead_id = l.id\r\n\t\t\tINNER JOIN domains d ON d.id = ld.domain_id\r\n\t\t\tWHERE l.status_id IN (2,8,9,12,14)\r\n\t\t\tAND   d.lead_blocked_id IS NOT NULL\r\n\t\t\tAND   ld.lead_id <> d.lead_blocked_id\r\n\t\t\tAND   l.deleted_at = '0000-00-00 00:00:00'\r\n\t\t\tAND   ld.deleted_at  = '0000-00-00 00:00:00'\r\n\t\t\tAND   l.owner_user_id <> d.user_blocked_id;\r\n\t\t\t\r\n\t\r\n\tDECLARE c_leads_domains_free\r\n\t\tCURSOR FOR \r\n\t\t\tSELECT ld.id AS lead_domain_id\r\n\t\t\tFROM leads l\r\n\t\t\tINNER JOIN leads_domains ld ON ld.lead_id = l.id\r\n\t\t\tINNER JOIN domains d ON d.id = ld.domain_id\r\n\t\t\tWHERE l.status_id IN (2,8,9,14)\r\n\t\t\tAND   d.lead_blocked_id IS NULL\r\n\t\t\tAND   l.deleted_at = '0000-00-00 00:00:00'\r\n\t\t\tAND   ld.deleted_at  = '0000-00-00 00:00:00';\r\n\t\t\t\t\t\r\n\t\t\r\n\t\r\n\tDECLARE CONTINUE HANDLER \r\n        FOR NOT FOUND SET finished = 1;\r\n        \r\nSTART TRANSACTION;\r\n\tOPEN c_leads_domains_others ;\r\n\tLDO: \r\n\tLOOP\r\n\r\n\t   \r\n\t\tFETCH c_leads_domains_others  INTO  v_lead_domain_id;\r\n\t\tIF finished = 1 THEN \r\n\t\t   close c_leads_domains_others;\r\n\t\t\tLEAVE LDO;\r\n\t\tEND IF;\r\n\t\tUPDATE leads_domains ld\r\n\t\tSET ld.deleted_user_id = 1,\r\n\t\t    ld.deleted_at = SYSDATE()\r\n\t\tWHERE ld.id = v_lead_domain_id;\t\t\r\n\tEND LOOP LDO;\r\n\t\r\n\tset finished = 0;\r\n\tOPEN c_leads_domains_free;\r\n\tLDF: \r\n\tLOOP\r\n\r\n\t   \r\n\t\tFETCH c_leads_domains_free  INTO  v_lead_domain_id;\r\n\t\tIF finished = 1 THEN \r\n\t\t   set finished = 0;\r\n\t\t   close c_leads_domains_free;\r\n\t\t\tLEAVE LDF;\r\n\t\tEND IF;\r\n\t\tUPDATE leads_domains ld\r\n\t\tSET ld.deleted_user_id = 1,\r\n\t\t    ld.deleted_at = SYSDATE()\r\n\t\tWHERE ld.id = v_lead_domain_id;\t\t\r\n\tEND LOOP LDF;\r\n\t\r\n\t\r\n\tUPDATE leads l\r\n\tSET deleted_at = SYSDATE(),\r\n\t    deleted_user_id = 1\r\n\tWHERE l.status_id   IN (2,8,9,12,14)\r\n\tAND   l.category_id <> 3\r\n\tAND   NOT EXISTS (SELECT 1 FROM leads_domains ld \r\n\t\t\t\t\t\t\tWHERE ld.lead_id = l.id \r\n\t\t\t\t\t\t\tAND   ld.deleted_at = '0000-00-00 00:00:00')\r\n\tAND l.deleted_at = '0000-00-00 00:00:00';\r\n \tCOMMIT;\r\nEND","imported_at":"2024-06-28 17:00"};